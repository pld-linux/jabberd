--- sm/main.c.orig	Sat Dec 18 08:41:54 2004
+++ sm/main.c	Sat Dec 18 09:24:36 2004
@@ -355,7 +355,8 @@
             xhash_iter_get(sm->sessions, NULL, (void *) &sess);
             sm_c2s_action(sess, "ended", NULL);
             sess_end(sess);
-        } while(xhash_iter_next(sm->sessions));
+        } while(xhash_count(sm->sessions) > 0);
+
     xhash_free(sm->sessions);
 
     mio_free(sm->mio);
